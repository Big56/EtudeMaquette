<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Test ensemble</title>
	<link type="text/css" rel="stylesheet" href="src/css/graph.css">
	<link type="text/css" rel="stylesheet" href="src/css/detail.css">
	<link type="text/css" rel="stylesheet" href="src/css/legend.css">
	<link type="text/css" rel="stylesheet" href="src/css/extensions.css">
	<script src="src/vendor/d3.v3.js"></script>
	<script src="src/js/Rickshaw.js"></script>
	<script type="text/javascript" src="src/js/phaser.min.js"></script>
    <style type="text/css">
        body
		{
            margin: 0;
        }
    </style>
</head>
<body>
	<div id="content">
		<div id="chart"></div>
	</div>
	<section>
		<div id="legend"></div>
	</section>

	<script type="text/javascript">

	/////////////////////////////// DECLARATIONS VARIABLES GLOBALES ///////////////////////////
	var vitesseVoiture;

	
	
	/////////////////////////////// COMPTEUR //////////////////////////////////////////////////
	var jeuCompteur = new Phaser.Game(500, 499, Phaser.AUTO, '', {preload: preloadC, create: createC, render:renderC, update : updateC});

	function preloadC()
	{
	  jeuCompteur.load.image('fond', 'src/Fond.png');
	  jeuCompteur.load.image('aiguille', 'src/Aiguille.png');
	  jeuCompteur.load.image('aiguille2', 'src/Aiguille2.png');
	}

	var fond, aiguille, compteur;

	function createC()
	{
	  fond = jeuCompteur.add.sprite(0, 0, 'fond');
	  aiguille = jeuCompteur.add.sprite(250,250,'aiguille');
	  aiguille2 = jeuCompteur.add.sprite(250,250,'aiguille2');
	  compteur = jeuCompteur.add.group()
	  compteur.add(fond)
	  compteur.add(aiguille)
	  compteur.add(aiguille2)
	  aiguille.anchor.x = 0.654
	  aiguille.anchor.y = 0.227
	  aiguille2.anchor.x = 0.654
	  aiguille2.anchor.y = 0.227
	  aiguille2.angle = 200
	}

	function renderC(){}

	function updateC()
	{
		aiguille.angle = vitesseVoiture *50
	}
	


	//////////////////////////////// VOITURE ///////////////////////////////////////////	
			pathOfFileToReadFrom="src/pente1.txt";
			var request = new XMLHttpRequest();
			request.open("GET", pathOfFileToReadFrom, false);
			request.send(null);
			var returnValue = request.responseText;
			
			var pas;
			var matchNum;
			matchNum=returnValue.match(/[\d,; ].*/g);

			if (matchNum.length>0)
			{
				var strX=matchNum.shift();
				console.log('x : '+strX);
				var tabX=strX.match(/\b\d+\b/g);
				for (var i=0; i<tabX.length; i++)
				{
					tabX[i]=parseInt(tabX[i]);
					
				}
			} else 
			{
				alert('echec ! aucun y present');
			}
			
			if (matchNum.length>0) {
				var strY=matchNum.shift();
				console.log('y : '+strY);
				var tabY=strY.match(/\b\d+\b/g);
				for (var i=0; i<tabY.length; i++)
				{
					tabY[i]=parseInt(tabY[i]);
				}
				
			} else
			{
				alert('echec ! aucun y present');
			}
			if (matchNum.length>0)
			{
				alert('autres donnees presentes');
			}
			if(tabY.length!=tabX.length)
			{
				alert('X et Y ne sont pas de memes tailles');
			}
	
		
	var jeuVoiture = new Phaser.Game(800, 480, Phaser.AUTO, 'jeuVoiture');

    var PhaserGame = function ()
	{
        this.bmd = null;
        this.voiture = null;
        this.mode = 2;
        this.points = {'x': [ 10, 700], 'y': [ 10, 400]};
        this.pi = 0;
        this.path = [];
		this.speed=0.5;
		this.upKey=null;
		this.downKey=null;
		this.screenPos=0;
    };

    PhaserGame.prototype =
	{
        init: function ()
		{
            this.game.renderer.renderSession.roundPixels = true;
            this.stage.backgroundColor = '#204090';
        },

        preload: function ()
		{
            this.load.image('voiture', 'src/Voiture.png');
        },

        create: function () {
            this.bmd = this.add.bitmapData(this.game.width, this.game.height);
            this.bmd.addToWorld();
            this.voiture = this.add.sprite(0, 0, 'voiture');
            this.voiture.anchor.set(0.5);
			
            var py = this.points.y;
			var px = this.points.x;
			
			for (var i =0; i < tabX.length; i++ )
			{
				px[i]=tabX[i];
				py[i]=tabY[i];
			}

            this.upKey = jeuVoiture.input.keyboard.addKey(Phaser.Keyboard.UP);
			this.downKey = jeuVoiture.input.keyboard.addKey(Phaser.Keyboard.DOWN);
			this.vit = jeuVoiture.add.text(16, 16, 'vitesse : '+ this.speed, { fontSize: '28px', fill: '#FFFFFF' });
			this.interp();
            this.plot();

			jeuVoiture.time.desiredFps=30;

        },

		interp: function() {
			this.path = [];

            var x = 1 / jeuVoiture.width;

            for (var i = 0; i <= 1; i += x)
            {
                if (this.mode === 0)
                {
                    var px = this.math.linearInterpolation(this.points.x, i);
                    var py = this.math.linearInterpolation(this.points.y, i);
                }
                else if (this.mode === 1)
                {
                    var px = this.math.bezierInterpolation(this.points.x, i);
                    var py = this.math.bezierInterpolation(this.points.y, i);
                }
                else if (this.mode === 2)
                {
                    var px = this.math.catmullRomInterpolation(this.points.x, i);
                    var py = this.math.catmullRomInterpolation(this.points.y, i);
                }
				
				
                this.path.push( { x: px, y: py });
			}
		},
        plot: function () {

            this.bmd.clear();

			for (var i = 0; i <this.path.length; i++){
				var px = this.path[i].x-this.screenPos;
				var py = this.path[i].y;
                this.bmd.rect(px, py, 1, 1, 'rgba(255, 255, 255, 1)');
            }

        },

        update: function () {

			vitesseVoiture = this.speed
            this.voiture.x = this.path[Math.floor(this.pi-this.screenPos)].x;
            this.voiture.y = this.path[Math.floor(this.pi)].y;
            this.pi+=this.speed;

			if (this.upKey.isDown && this.speed<2 )
			{
				this.speed=Math.floor(this.speed*10+1)/10;
				this.vit.text = 'vitesse : ' + this.speed;
			}
			if (this.downKey.isDown && this.speed>0)
			{
				this.speed=Math.floor(this.speed*10-1)/10;
				this.vit.text = 'vitesse : ' + this.speed;
			}
			
			if (this.pi >= this.path.length)
            {
                this.pi = 0;
				this.speed=0;
				this.vit.text = 'vitesse : ' + this.speed;
            }
			
			var prev = this.screenPos;
			this.screenPos=Math.floor( (this.points.x[0]+this.points.x[this.points.x.length-1]-this.game.width)*this.pi/this.path.length ) ;
			
			if(prev!=this.screenPos)
			{
				this.plot();
			}
		
        }

    };

    jeuVoiture.state.add('Game', PhaserGame, true);
	
	

	///////////////////////// GRAPHIQUE ////////////////////////////////
	var tv = 100/3; // pour coller au dt
	var valeursConsigne = 100

	var graph = new Rickshaw.Graph( {
		element: document.getElementById("chart"),
		width: 1000,
		height: 500,
		min : 0,
		max : 200,
		renderer: 'line',
		series: new Rickshaw.Series.FixedDuration([{ name: 'Vitesse', color : 'red' }, { name: 'Consigne', color : 'blue' }], undefined, {
			timeInterval: tv,
			maxDataPoints: 1000,
			timeBase: new Date().getTime() / 1000
		}) 
	} );

	graph.render();

	var legend = new Rickshaw.Graph.Legend( {
		graph: graph,
		element: document.getElementById('legend')
	} );

	var ticksTreatment = 'glow';

	var xAxis = new Rickshaw.Graph.Axis.Time( {
		graph: graph,
		ticksTreatment: ticksTreatment,
	} );

	xAxis.render();

	var yAxis = new Rickshaw.Graph.Axis.Y( {
		graph: graph,
		tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
		ticksTreatment: ticksTreatment
	} );

	yAxis.render();
	
	var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight( {
	graph: graph,
	legend: legend
	} );

	// Ajour des donnÃ©es tous les dt

	var iv = setInterval( function() {
		var data = {Vitesse : vitesseVoiture*50};
		data.Consigne = valeursConsigne
		graph.series.addData(data);
		graph.render();
	}, tv );

	</script>
</body>
</html>